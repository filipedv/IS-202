@model IEnumerable<OBLIG1.ViewModels.Admin.AdminUserListViewModel>

@{
    // Tittel som viser i layouten og nettleserfanen
    ViewData["Title"] = "User administration";
}

@section Styles {
    <style>
        /* Fast plassert logout-knapp nederst til venstre */
        .admin-logout-fixed {
            position: fixed;
            left: 24px;
            bottom: 24px;
            z-index: 1000;
        }

        /* Litt mer kompakt rad for filter + knapp */
        .admin-header-actions {
            display: flex;
            align-items: center;
            gap: 4px;              /* mindre mellomrom */
            flex-wrap: nowrap;     /* tving alt på én linje */
        }

        .admin-role-filter {
            width: 130px;          /* smalere dropdown */
            max-width: 40%;
        }

        @@media (max-width: 576px) {
            /* På veldig smale skjermer får den lov til å wrappe igjen */
            .admin-header-actions {
                flex-wrap: wrap;
            }
        }
    </style>
}


<div class="container my-4">
    <div class="rounded shadow-sm p-3">
        @* Header med tittel + filter + "Add user"-knapp *@
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0">Users</h2>

            <div class="admin-header-actions">
                
                <!-- FILTER til venstre for Add user -->
                <select id="roleFilter"
                        class="form-select form-select-sm admin-role-filter">
                    <option value="all">All roles</option>
                    <option value="Pilot">Pilot</option>
                    <option value="Registerforer">Registerforer</option>
                    <option value="Admin">Admin</option>
                </select>

                <!-- ADD USER-knapp -->
                <a asp-action="Create" class="btn btn-primary">
                    Add user
                </a>
            </div>
        </div>
                @* Tabell som viser alle brukere *@
        <table class="table table-striped table-sm align-middle mb-0" id="usersTable">
            <thead class="table-light">
            <tr>
                <th scope="col">Email</th>
                <th scope="col">Roles</th>
                <th scope="col" class="text-end" style="width:160px;"></th>
            </tr>
            </thead>
            <tbody>
            @* Genererer én rad per bruker *@
            @foreach (var u in Model)
            {
                <tr>
                    <td>@u.Email</td>
                    @* Viser rollene som kommaseparert liste *@
                    <td class="user-roles">@string.Join(", ", u.Roles)</td>
                    
                    @* Edit + Delete-knapper *@
                    <td class="text-end">
                        
                        @* Edit-knapp *@
                        <a asp-action="Edit"
                           asp-route-id="@u.Id"
                           class="btn btn-sm btn-secondary me-1">
                            Edit
                        </a>
                        
                        @* Delete-knapp i form (POST) + confirmation-popup *@
                        <form asp-action="Delete"
                              asp-route-id="@u.Id"
                              method="post"
                              class="d-inline"
                              onsubmit="return confirm('Delete this user?');">
                            @Html.AntiForgeryToken()
                            <button type="submit"
                                    class="btn btn-sm btn-danger">
                                Delete
                            </button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>

<!-- LOGOUT nederst til venstre -->
@if (User.Identity?.IsAuthenticated ?? false)
{
    <form asp-controller="Auth"
          asp-action="Logout"
          method="post"
          class="admin-logout-fixed">
        @Html.AntiForgeryToken()
        <button type="submit" class="btn btn-secondary">
            Log out
        </button>
    </form>
}

@section Scripts {
    <script>
        (function () {
            const filter = document.getElementById('roleFilter');
            const table = document.getElementById('usersTable');
            // Sjekk om elementene finnes
            if (!filter || !table) return;
            
            //Filtrering når brukere velger rolle
            filter.addEventListener('change', function () {
                const value = this.value;
                const rows = table.querySelectorAll('tbody tr');

                rows.forEach(row => {
                    const rolesCell = row.querySelector('.user-roles');
                    if (!rolesCell) return;

                    const rolesText = rolesCell.textContent || "";
                    if (value === 'all') {
                        row.style.display = '';
                    } else {
                        // sjekk om rollen finnes i teksten
                        if (rolesText.includes(value)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
            });
        })();
    </script>
}
